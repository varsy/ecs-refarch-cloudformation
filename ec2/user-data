#cloud-config
locksmith:
  reboot_strategy: off
systemd:
  units:
    - name: format-mnt-data.service
      enable: true
      contents: |
        [Unit]
        Before=teamcity-server.service mnt-data.mount
        ConditionPathExists=!/dev/mapper/app-data
        [Service]
        Type=oneshot
        ExecStart=/bin/bash -c \
        '/usr/sbin/pvcreate /dev/xvdg && \
        /usr/sbin/vgcreate app /dev/xvdg && \
        /usr/sbin/lvcreate -l 100%FREE -n data app && \
        /usr/sbin/mkfs.ext4 /dev/mapper/app-data'
        [Install]
        WantedBy=multi-user.target
    - name: mnt-data.mount
      enable: true
      contents: |
        [Unit]
        Before=teamcity-server.service
        After=format-mnt-data.service
        Requires=format-mnt-data.service
        ConditionVirtualization=!container
        Conflicts=umount.target
        [Mount]
        What=/dev/mapper/app-data
        Where=/mnt/data
        Type=ext4
        Options=
        [Install]
        RequiredBy=teamcity-server.service
    - name: get-mysql-connector.service
      enable: true
      contents: |
        [Unit]
        Before=teamcity-server.service
        After=mnt-data.mount
        Requires=mnt-data.mount
        ConditionPathExists=!/mnt/data/teamcity/lib/jdbc/mysql-connector-java-bin.jar
        [Service]
        Type=oneshot
        ExecStart=/usr/bin/mkdir -p /mnt/data/teamcity/lib/jdbc
        ExecStart=/usr/bin/wget -O /mnt/data/teamcity/lib/jdbc/mysql-connector-java-bin.jar http://central.maven.org/maven2/mysql/mysql-connector-java/5.1.43/mysql-connector-java-5.1.43.jar
        [Install]
        WantedBy=multi-user.target
    - name: prepare-db-properties.service
      enable: true
      contents: |
        [Unit]
        Before=teamcity-server.service
        After=mnt-data.mount
        Requires=mnt-data.mount
        ConditionPathExists=!/mnt/data/teamcity/config/database.properties
        [Service]
        Type=oneshot
        ExecStart=/usr/bin/mkdir -p /mnt/data/teamcity/config
        ExecStart=/bin/bash -c 'echo connectionProperties.user=teamcity > /mnt/data/teamcity/config/database.properties'
        ExecStart=/bin/bash -c 'echo connectionProperties.password=t34mc1ty >> /mnt/data/teamcity/config/database.properties'
        ExecStart=/bin/bash -c 'echo connectionUrl=jdbc\:mysql\://${RDSAddress}/teamcity${AWS::StackName}db >> /mnt/data/teamcity/config/database.properties'
        [Install]
        WantedBy=multi-user.target
    - name: teamcity-server.service
      enable: true
      contents: |
        [Unit]
        Description=TeamCity Server
        After=docker.service mnt-data.mount get-mysql-connector.service prepare-db-properties.service
        Requires=docker.service mnt-data.mount get-mysql-connector.service prepare-db-properties.service
        [Service]
        TimeoutStartSec=1200s
        ExecStart=/usr/bin/docker run \
        -v /mnt/data/teamcity:/data/teamcity_server/datadir \
        -v /mnt/data/logs/teamcity:/opt/teamcity/logs \
        -p 80:8111 \
        --name teamcity-server \
        jetbrains/teamcity-server:latest
        ExecStop=-/usr/bin/docker exec teamcity-server /opt/teamcity/bin/teamcity-server.sh stop 60
        ExecStopPost=-/usr/bin/docker stop teamcity-server
        ExecStopPost=-/usr/bin/docker rm teamcity-server
        Restart=always
        [Install]
        WantedBy=multi-user.target